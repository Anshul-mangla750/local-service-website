<%- include('../partials/header', { title: 'Bookings Management' }) %>

<div class="dashboard-header">
  <h1><i class="fas fa-calendar-check me-3"></i>Bookings Management</h1>
  <p>Manage all your service bookings, update statuses, and track customer requests.</p>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-3 col-md-6">
    <div class="card h-100 border-0 shadow-sm" style="background: var(--warning-gradient); color: white;">
      <div class="card-body text-center">
        <div class="mb-3">
          <i class="fas fa-clock fa-3x opacity-75"></i>
        </div>
        <h2 class="mb-2 fw-bold"><%= bookings.filter(b => b.status === 'pending').length %></h2>
        <h6 class="mb-0 opacity-90">Pending</h6>
        <small class="opacity-75">Awaiting response</small>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card h-100 border-0 shadow-sm" style="background: var(--primary-gradient); color: white;">
      <div class="card-body text-center">
        <div class="mb-3">
          <i class="fas fa-check-circle fa-3x opacity-75"></i>
        </div>
        <h2 class="mb-2 fw-bold"><%= bookings.filter(b => b.status === 'accepted').length %></h2>
        <h6 class="mb-0 opacity-90">Accepted</h6>
        <small class="opacity-75">Confirmed bookings</small>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card h-100 border-0 shadow-sm" style="background: var(--success-gradient); color: white;">
      <div class="card-body text-center">
        <div class="mb-3">
          <i class="fas fa-check-double fa-3x opacity-75"></i>
        </div>
        <h2 class="mb-2 fw-bold"><%= bookings.filter(b => b.status === 'completed').length %></h2>
        <h6 class="mb-0 opacity-90">Completed</h6>
        <small class="opacity-75">Finished jobs</small>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card h-100 border-0 shadow-sm" style="background: var(--danger-gradient); color: white;">
      <div class="card-body text-center">
        <div class="mb-3">
          <i class="fas fa-times-circle fa-3x opacity-75"></i>
        </div>
        <h2 class="mb-2 fw-bold"><%= bookings.filter(b => b.status === 'rejected').length %></h2>
        <h6 class="mb-0 opacity-90">Rejected</h6>
        <small class="opacity-75">Declined requests</small>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div>
            <h5 class="mb-1 fw-bold text-dark"><i class="fas fa-list me-2 text-primary"></i>All Bookings</h5>
            <p class="text-muted mb-0 small">Complete list of all your service bookings</p>
          </div>
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="statusFilter" style="width: auto;">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="accepted">Accepted</option>
              <option value="completed">Completed</option>
              <option value="rejected">Rejected</option>
            </select>
            <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search bookings..." style="width: 200px;">
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <% if (bookings.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-hover mb-0" id="bookingsTable">
              <thead class="table-light">
                <tr>
                  <th class="border-0 fw-semibold px-4 py-3"><i class="fas fa-tools me-2 text-muted"></i>Service</th>
                  <th class="border-0 fw-semibold px-4 py-3"><i class="fas fa-user me-2 text-muted"></i>Customer</th>
                  <th class="border-0 fw-semibold px-4 py-3"><i class="fas fa-calendar me-2 text-muted"></i>Date & Time</th>
                  <th class="border-0 fw-semibold px-4 py-3"><i class="fas fa-sticky-note me-2 text-muted"></i>Notes</th>
                  <th class="border-0 fw-semibold px-4 py-3"><i class="fas fa-info-circle me-2 text-muted"></i>Status</th>
                  <th class="border-0 fw-semibold px-4 py-3"><i class="fas fa-cogs me-2 text-muted"></i>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% bookings.forEach(b => { %>
                  <tr class="align-middle booking-row" data-status="<%= b.status %>">
                    <td class="px-4 py-3">
                      <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                          <i class="fas fa-tools text-primary"></i>
                        </div>
                        <div>
                          <div class="fw-semibold"><%= b.serviceId.title %></div>
                          <small class="text-muted">ID: <%= b._id.toString().slice(-6) %></small>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                          <i class="fas fa-user text-success"></i>
                        </div>
                        <div>
                          <div class="fw-semibold"><%= b.userId.username %></div>
                          <small class="text-muted"><%= b.userId.email %></small>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="fw-semibold"><%= new Date(b.date).toLocaleDateString() %></div>
                      <small class="text-muted"><i class="fas fa-clock me-1"></i><%= b.time %></small>
                    </td>
                    <td class="px-4 py-3">
                      <div class="text-truncate" style="max-width: 200px;" title="<%= b.notes || 'No notes' %>">
                        <%= b.notes || '<em class="text-muted">No notes</em>' %>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <% if (b.status === 'pending') { %>
                        <span class="badge bg-warning text-dark px-3 py-2">
                          <i class="fas fa-clock me-1"></i>Pending
                        </span>
                      <% } else if (b.status === 'accepted') { %>
                        <span class="badge bg-info text-white px-3 py-2">
                          <i class="fas fa-check me-1"></i>Accepted
                        </span>
                      <% } else if (b.status === 'completed') { %>
                        <span class="badge bg-success px-3 py-2">
                          <i class="fas fa-check-double me-1"></i>Completed
                        </span>
                      <% } else if (b.status === 'rejected') { %>
                        <span class="badge bg-danger px-3 py-2">
                          <i class="fas fa-times me-1"></i>Rejected
                        </span>
                      <% } else { %>
                        <span class="badge bg-secondary px-3 py-2">
                          <i class="fas fa-question me-1"></i><%= b.status %>
                        </span>
                      <% } %>
                    </td>
                    <td class="px-4 py-3">
                      <form method="POST" action="/dashboard/bookings/<%= b._id %>/status?_method=PUT" class="d-flex gap-2" onsubmit="return confirm('Are you sure you want to update this booking status?');">
                        <select name="status" class="form-select form-select-sm" required>
                          <option value="pending" <%= b.status==='pending'?'selected':'' %>>Pending</option>
                          <option value="accepted" <%= b.status==='accepted'?'selected':'' %>>Accept</option>
                          <option value="rejected" <%= b.status==='rejected'?'selected':'' %>>Reject</option>
                          <option value="completed" <%= b.status==='completed'?'selected':'' %>>Complete</option>
                        </select>
                        <button type="submit" class="btn btn-primary btn-sm">
                          <i class="fas fa-save me-1"></i>Update
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="fas fa-calendar-times fa-4x text-muted opacity-50"></i>
            </div>
            <h5 class="text-muted mb-2">No Bookings Found</h5>
            <p class="text-muted mb-4">You haven't received any booking requests yet.</p>
            <a href="/services" class="btn btn-primary">
              <i class="fas fa-plus me-2"></i>Add Services
            </a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const statusFilter = document.getElementById('statusFilter');
  const searchInput = document.getElementById('searchInput');
  const tableRows = document.querySelectorAll('.booking-row');

  function filterBookings() {
    const statusValue = statusFilter.value.toLowerCase();
    const searchValue = searchInput.value.toLowerCase();

    tableRows.forEach(row => {
      const status = row.dataset.status.toLowerCase();
      const text = row.textContent.toLowerCase();

      const statusMatch = !statusValue || status === statusValue;
      const searchMatch = !searchValue || text.includes(searchValue);

      row.style.display = statusMatch && searchMatch ? '' : 'none';
    });
  }

  statusFilter.addEventListener('change', filterBookings);
  searchInput.addEventListener('input', filterBookings);
});
</script>

<%- include('../partials/footer') %>
